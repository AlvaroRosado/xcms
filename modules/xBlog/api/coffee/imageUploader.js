// Generated by CoffeeScript 1.10.0
var ImageUploader;

ImageUploader = function(dialog) {
  var image, xhr, xhrComplete, xhrProgress;
  image = void 0;
  xhr = void 0;
  xhrComplete = void 0;
  xhrProgress = void 0;
  dialog.bind('imageUploader.cancelUpload', function(setDialogEmpty) {
    if (setDialogEmpty == null) {
      setDialogEmpty = true;
    }
    if (xhr) {
      xhr.upload.removeEventListener('progress', xhrProgress);
      xhr.removeEventListener('readystatechange', xhrComplete);
      xhr.abort();
    }
    if (setDialogEmpty) {
      dialog.state('empty');
    }
  });
  dialog.bind('imageUploader.clear', function() {
    dialog.clear();
    image = null;
  });
  dialog.bind('imageUploader.fileReady', function(file, data) {
    var formData;
    if (data == null) {
      data = null;
    }
    formData = void 0;
    xhrProgress = function(ev) {
      dialog.progress(ev.loaded / ev.total * 100);
    };
    xhrComplete = function(ev) {
      var response;
      response = void 0;
      if (ev.target.readyState !== 4) {
        return;
      }
      xhr = null;
      xhrProgress = null;
      xhrComplete = null;
      if (parseInt(ev.target.status) === 200) {
        response = JSON.parse(ev.target.responseText);
        image = {
          size: response.size,
          url: response.url,
          id: response.id
        };
        dialog.populate(image.url, image.size, image.id);
      } else {
        new ContentTools.FlashUI('no');
        dialog.state('error');
      }
    };
    dialog.state('uploading');
    dialog.progress(0);
    formData = new FormData;
    formData.append('image', file);
    if (data !== null) {
      formData.append("left", data.left);
      formData.append("top", data.top);
      formData.append("width", data.width);
      formData.append("height", data.height);
    }
    xhr = new XMLHttpRequest;
    xhr.upload.addEventListener('progress', xhrProgress);
    xhr.addEventListener('readystatechange', xhrComplete);
    xhr.open('POST', window.baseUrl + '/upload-image', true);
    xhr.send(formData);
  });
  dialog.bind('imageUploader.save', function() {
    var crop, cropRegion, formData;
    dialog.save(image.url, image.size, {
      'data-ce-max-width': image.size[0],
      'data-xid': image.id
    });
    return;
    crop = void 0;
    cropRegion = void 0;
    formData = void 0;
    xhrComplete = function(ev) {
      var response;
      if (ev.target.readyState !== 4) {
        return;
      }
      xhr = null;
      xhrComplete = null;
      dialog.busy(false);
      if (parseInt(ev.target.status) === 200) {
        response = JSON.parse(ev.target.responseText);
        dialog.save(response.url, response.size, {
          'alt': response.alt,
          'data-ce-max-width': image.size[0]
        });
      } else {
        new ContentTools.FlashUI('no');
      }
    };
    dialog.busy(true);
    formData = new FormData;
    formData.append('url', image.url);
    formData.append('width', 600);
    if (dialog.cropRegion()) {
      formData.append('crop', dialog.cropRegion());
    }
    xhr = new XMLHttpRequest;
    xhr.addEventListener('readystatechange', xhrComplete);
    xhr.open('POST', '/insert-image', true);
    xhr.send(formData);
  });
};

window.ImageUploader = ImageUploader;
